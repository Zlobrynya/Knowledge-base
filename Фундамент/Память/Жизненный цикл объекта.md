Reference-type проживают свой жизненный цикл, он показан на схеме ниже

![[Pasted image 20250820214415.png]]


Как видно из схемы reference-type может прожить 5 состояний: life, deiniting, deinited, feed, dead
## Life
- Объект жив в памяти. 
- Счетчики инициализируется: strong 1, weak 1, unowned 1, без side table.
- Все операции работают нормально. 
- В случае когда strong == 0, переходит в состояние Deiniting.
## Deiniting
- Выполняется метод `deinit()`, после выполнения вызывается `swift_deallocObject`
- unowned ссылки вызывают fatalError() -> swift_abortRetainUnowned().
- unowned ссылки могут еще добавляться.
- weak ссылки возвращают `nil`
- Идет проверка на наличие [unowned == 1 или есть sideTable - canBeFreedNow()](https://github.com/swiftlang/swift/blob/ea9c66d73636035fd0bec7064274ccbb15cb9f97/stdlib/public/SwiftShims/swift/shims/RefCount.h#L974)
	- Если нет, то освобождение памяти и переход в `Dead`
	- Если есть, то переход в состояние `Deinited` 
## Deinited
Ситуация когда **нету** sideTable
- unowned ссылки вызывают fatalError() -> swift_abortRetainUnowned().
- Операции с unowned, strong не проводятся
- Если нету sideTable, то Dead
Ситуация когда **есть** sideTable
- Вызов метода `deinit()` завершился
- weak ссылки возвращают `nil`
- Новые weak ссылки не добавляются
-  `canBeFreedNow()` всегда false, поэтому нельзя перейти в состояние Dead
- Работает так же как и без таблицы (кроме последнего пункта)
## Feed
- Возникает только если есть sideTable
- Сам объект освобожден, но sideTable живет
- Операции с unowned, strong не проводятся
 - weak ссылки возвращают `nil`
 - Когда weak == 0, переходит в Dead
## Dead
- Объекта и его таблицы не существует

## Источники:
- https://github.com/swiftlang/swift/blob/ea9c66d73636035fd0bec7064274ccbb15cb9f97/stdlib/public/SwiftShims/swift/shims/RefCount.h#L111
- https://ios-interview.ru/object-lifecycle/ 